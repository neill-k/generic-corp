generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Agent {
  id            String   @id @default(uuid())
  name          String   @unique
  displayName   String
  role          String
  department    String
  level         String
  personality   String   @db.Text
  status        String   @default("idle")
  currentTaskId String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  tasks         Task[]    @relation("assignee")
  delegated     Task[]    @relation("delegator")
  sentMessages  Message[] @relation("sender")
  receivedMsgs  Message[] @relation("recipient")
  orgNode       OrgNode?
}

model OrgNode {
  id           String   @id @default(uuid())
  agentId      String   @unique
  parentNodeId String?
  position     Int      @default(0)

  agent    Agent    @relation(fields: [agentId], references: [id])
  parent   OrgNode? @relation("hierarchy", fields: [parentNodeId], references: [id])
  children OrgNode[] @relation("hierarchy")
}

model Task {
  id           String   @id @default(uuid())
  parentTaskId String?
  assigneeId   String
  delegatorId  String?
  prompt       String   @db.Text
  context      String?  @db.Text
  priority     Int      @default(0)
  status       String   @default("pending")
  result       String?  @db.Text
  learnings    String?  @db.Text
  costUsd      Float?
  durationMs   Int?
  numTurns     Int?
  createdAt    DateTime @default(now())
  startedAt    DateTime?
  completedAt  DateTime?

  assignee   Agent  @relation("assignee", fields: [assigneeId], references: [id])
  delegator  Agent? @relation("delegator", fields: [delegatorId], references: [id])
  parentTask Task?  @relation("subtasks", fields: [parentTaskId], references: [id])
  subtasks   Task[] @relation("subtasks")
}

model Message {
  id          String   @id @default(uuid())
  fromAgentId String?
  toAgentId   String
  threadId    String?
  subject     String?
  body        String   @db.Text
  type        String   @default("direct")
  status      String   @default("pending")
  createdAt   DateTime @default(now())
  readAt      DateTime?

  sender    Agent? @relation("sender", fields: [fromAgentId], references: [id])
  recipient Agent  @relation("recipient", fields: [toAgentId], references: [id])
}
