generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Agent {
  id              String   @id @default(uuid())
  name            String   @unique
  displayName     String
  role            String
  department      String
  level           String
  personality     String   @db.Text
  status          String   @default("idle")
  currentTaskId   String?
  toolPermissions Json     @default("{}")
  avatarColor     String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  tasks         Task[]    @relation("assignee")
  delegated     Task[]    @relation("delegator")
  sentMessages  Message[] @relation("sender")
  receivedMsgs  Message[] @relation("recipient")
  orgNode       OrgNode?
}

model OrgNode {
  id           String   @id @default(uuid())
  agentId      String   @unique
  parentNodeId String?
  position     Int      @default(0)
  positionX    Float    @default(0)
  positionY    Float    @default(0)

  agent    Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
  parent   OrgNode? @relation("hierarchy", fields: [parentNodeId], references: [id])
  children OrgNode[] @relation("hierarchy")
}

model Task {
  id           String   @id @default(uuid())
  parentTaskId String?
  assigneeId   String?
  delegatorId  String?
  prompt       String   @db.Text
  context      String?  @db.Text
  priority     Int      @default(0)
  status       String   @default("pending")
  tags         Json     @default("[]")
  result       String?  @db.Text
  learnings    String?  @db.Text
  costUsd      Float?
  durationMs   Int?
  numTurns     Int?
  createdAt    DateTime @default(now())
  startedAt    DateTime?
  completedAt  DateTime?

  assignee   Agent? @relation("assignee", fields: [assigneeId], references: [id], onDelete: SetNull)
  delegator  Agent? @relation("delegator", fields: [delegatorId], references: [id], onDelete: SetNull)
  parentTask Task?  @relation("subtasks", fields: [parentTaskId], references: [id])
  subtasks   Task[] @relation("subtasks")

  @@index([assigneeId])
  @@index([status])
  @@index([createdAt])
}

model Message {
  id          String   @id @default(uuid())
  fromAgentId String?
  toAgentId   String
  threadId    String?
  subject     String?
  body        String   @db.Text
  type        String   @default("direct")
  status      String   @default("pending")
  createdAt   DateTime @default(now())
  readAt      DateTime?

  sender    Agent? @relation("sender", fields: [fromAgentId], references: [id])
  recipient Agent  @relation("recipient", fields: [toAgentId], references: [id])

  @@index([threadId])
  @@index([fromAgentId])
  @@index([toAgentId])
  @@index([createdAt])
}

model Workspace {
  id          String   @id @default(uuid())
  name        String
  slug        String   @unique
  description String   @default("")
  timezone    String   @default("America/New_York")
  language    String   @default("en-US")

  llmProvider    String  @default("anthropic")
  llmModel       String  @default("claude-sonnet-4-20250514")
  llmApiKeyEnc   String  @default("")
  llmApiKeyIv    String  @default("")
  llmApiKeyTag   String  @default("")

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model McpServerConfig {
  id                  String    @id @default(uuid())
  name                String
  protocol            String
  uri                 String
  status              String    @default("disconnected")
  toolCount           Int       @default(0)
  lastPingAt          DateTime?
  errorMessage        String?
  consecutiveFailures Int       @default(0)
  iconName            String?
  iconColor           String?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@index([status])
}

model ToolPermission {
  id          String   @id @default(uuid())
  name        String   @unique
  description String
  iconName    String
  enabled     Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Tenant {
  id                   String    @id @default(uuid())
  slug                 String    @unique @db.VarChar(63)
  schemaName           String    @unique @map("schema_name") @db.VarChar(63)
  status               String    @default("active") @db.VarChar(20)
  planTier             String    @default("free") @map("plan_tier") @db.VarChar(20)
  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")
  deletedAt            DateTime? @map("deleted_at")
  allowedDomains       String[]  @map("allowed_domains")
  apiKeyHash           String?   @map("api_key_hash")
  maxAgents            Int?      @map("max_agents")
  maxTasksPerMonth     Int?      @map("max_tasks_per_month")
  storageLimitGb       Int?      @map("storage_limit_gb")
  stripeCustomerId     String?   @map("stripe_customer_id") @db.VarChar(255)
  stripeSubscriptionId String?   @map("stripe_subscription_id") @db.VarChar(255)
  adminEmail           String    @map("admin_email") @db.VarChar(255)

  @@index([status])
  @@index([slug])
  @@map("tenants")
}
